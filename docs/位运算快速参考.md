# 位运算快速参考

版本：1.0

## 目录

- [基本概念](#基本概念)
- [位运算符](#位运算符)
- [常用技巧](#常用技巧)
- [实战示例](#实战示例)

## 基本概念

### 二进制表示

```
十进制    二进制      十六进制
0         0b0000      0x0
1         0b0001      0x1
2         0b0010      0x2
3         0b0011      0x3
4         0b0100      0x4
5         0b0101      0x5
6         0b0110      0x6
7         0b0111      0x7
8         0b1000      0x8
9         0b1001      0x9
10        0b1010      0xA
11        0b1011      0xB
12        0b1100      0xC
13        0b1101      0xD
14        0b1110      0xE
15        0b1111      0xF
```

### 位索引

```
大端字节序（从左到右递减）：
|7 6 5 4 |3 2 1 0 |
|1 0 1 0 |1 1 0 0 |

小端字节序（从左到右递增）：
|0 1 2 3 |4 5 6 7 |
|1 0 1 0 |1 1 0 0 |
```

## 位运算符

### 1. 按位与（AND）- &

**规则**：两位都为1时结果为1，否则为0

```
  1010
& 1100
------
  1000
```

**用途**：
- 提取特定位
- 清零特定位
- 判断奇偶性

**示例**：
```python
# 提取低4位
a = 0xFF
低4位 = a & 0x0F  # 结果：0x0F (15)

# 判断奇偶
数字 = 7
是奇数 = 数字 & 1  # 结果：1（奇数）

# 清零高4位
b = 0xFF
清零高4位 = b & 0x0F  # 结果：0x0F (15)
```

### 2. 按位或（OR）- |

**规则**：两位有一个为1时结果为1

```
  1010
| 1100
------
  1110
```

**用途**：
- 设置特定位为1
- 合并位标志

**示例**：
```python
# 设置第3位为1
a = 0b1010
设置第3位 = a | 0b1000  # 结果：0b1010 (10)

# 合并权限
读权限 = 0b0001
写权限 = 0b0010
读写权限 = 读权限 | 写权限  # 结果：0b0011 (3)
```

### 3. 按位异或（XOR）- ^

**规则**：两位不同时结果为1，相同时为0

```
  1010
^ 1100
------
  0110
```

**用途**：
- 翻转特定位
- 简单加密
- 交换变量（不推荐）

**示例**：
```python
# 翻转所有位
a = 0b1010
翻转 = a ^ 0b1111  # 结果：0b0101 (5)

# 简单加密
原文 = 0x42
密钥 = 0xFF
密文 = 原文 ^ 密钥  # 加密
解密 = 密文 ^ 密钥  # 解密，结果等于原文
```

### 4. 按位取反（NOT）- ~

**规则**：0变1，1变0

```
~ 1010
------
  0101（实际是补码，显示为负数）
```

**注意**：Python中 `~x` 等于 `-(x+1)`

**示例**：
```python
# 取反（需要掩码限制位数）
a = 0b1010
取反8位 = ~a & 0xFF  # 结果：0b11110101 (245)

# 创建掩码
位数 = 4
掩码 = ~(~0 << 位数)  # 结果：0b1111 (15)
```

### 5. 左移（Left Shift）- <<

**规则**：向左移动n位，右边补0

```
  1010 << 2
= 101000
```

**用途**：
- 乘以2的幂次
- 构造位掩码
- 位字段组合

**示例**：
```python
# 乘以2的幂次
a = 5
乘以4 = a << 2  # 结果：20（5 * 2^2）

# 构造掩码
位位置 = 3
掩码 = 1 << 位位置  # 结果：0b1000 (8)

# RGB组合
R = 0xFF
G = 0x80
B = 0x40
颜色 = (R << 16) | (G << 8) | B  # 结果：0xFF8040
```

### 6. 右移（Right Shift）- >>

**规则**：向右移动n位，左边补0（逻辑右移）

```
  1010 >> 2
= 0010
```

**用途**：
- 除以2的幂次
- 提取高位
- 位字段分解

**示例**：
```python
# 除以2的幂次
a = 20
除以4 = a >> 2  # 结果：5（20 / 2^2）

# 提取RGB分量
颜色 = 0xFF8040
R = (颜色 >> 16) & 0xFF  # 结果：0xFF (255)
G = (颜色 >> 8) & 0xFF   # 结果：0x80 (128)
B = 颜色 & 0xFF          # 结果：0x40 (64)
```

## 常用技巧

### 1. 检查第n位是否为1

```python
数字 = 0b1010
位位置 = 3
是否为1 = (数字 >> 位位置) & 1  # 结果：1
```

### 2. 设置第n位为1

```python
数字 = 0b1010
位位置 = 2
设置为1 = 数字 | (1 << 位位置)  # 结果：0b1110
```

### 3. 清除第n位（设为0）

```python
数字 = 0b1010
位位置 = 3
清除 = 数字 & ~(1 << 位位置)  # 结果：0b0010
```

### 4. 翻转第n位

```python
数字 = 0b1010
位位置 = 2
翻转 = 数字 ^ (1 << 位位置)  # 结果：0b1110
```

### 5. 提取连续的n位

```python
数字 = 0b11010110
起始位 = 2
位数 = 3
提取 = (数字 >> 起始位) & ((1 << 位数) - 1)  # 结果：0b101
```

### 6. 判断是否为2的幂次

```python
数字 = 8
是2的幂次 = (数字 & (数字 - 1)) == 0  # 结果：True
```

### 7. 计算二进制中1的个数

```python
# 使用循环
数字 = 0b1010
计数 = 0
临时 = 数字
# 循环：临时 = 临时 & (临时 - 1)，计数++
# 结果：2
```

### 8. 交换两个数（不推荐，仅作演示）

```python
a = 5
b = 7
a = a ^ b
b = a ^ b  # b = 5
a = a ^ b  # a = 7
```

### 9. 获取最低位的1

```python
数字 = 0b1010
最低位1 = 数字 & (-数字)  # 结果：0b0010
```

### 10. 清除最低位的1

```python
数字 = 0b1010
清除最低位1 = 数字 & (数字 - 1)  # 结果：0b1000
```

## 实战示例

### 示例1：权限管理

```python
# 定义权限位
READ = 0b0001      # 读权限
WRITE = 0b0010     # 写权限
EXECUTE = 0b0100   # 执行权限
DELETE = 0b1000    # 删除权限

# 设置权限
用户权限 = READ | WRITE  # 读写权限

# 检查权限
有读权限 = (用户权限 & READ) != 0      # True
有执行权限 = (用户权限 & EXECUTE) != 0  # False

# 添加权限
用户权限 = 用户权限 | EXECUTE  # 添加执行权限

# 移除权限
用户权限 = 用户权限 & ~WRITE  # 移除写权限
```

### 示例2：RGB颜色处理

```python
endian: big

# 创建颜色
R = 255
G = 128
B = 64
颜色 = (R << 16) | (G << 8) | B  # 0xFF8040

# 提取颜色分量
红色 = (颜色 >> 16) & 0xFF  # 255
绿色 = (颜色 >> 8) & 0xFF   # 128
蓝色 = 颜色 & 0xFF          # 64

# 修改颜色分量（将绿色改为200）
新绿色 = 200
颜色 = (颜色 & 0xFF00FF) | (新绿色 << 8)  # 0xFFC840
```

### 示例3：IP地址处理

```python
# 构造IP地址 192.168.1.1
段1 = 192
段2 = 168
段3 = 1
段4 = 1
IP = (段1 << 24) | (段2 << 16) | (段3 << 8) | 段4  # 0xC0A80101

# 解析IP地址
A = (IP >> 24) & 0xFF  # 192
B = (IP >> 16) & 0xFF  # 168
C = (IP >> 8) & 0xFF   # 1
D = IP & 0xFF          # 1

# 子网掩码 255.255.255.0
掩码 = 0xFFFFFF00

# 网络地址
网络地址 = IP & 掩码  # 0xC0A80100 (192.168.1.0)

# 主机地址
主机地址 = IP & ~掩码  # 0x00000001 (0.0.0.1)
```

### 示例4：位标志状态

```python
# 状态标志
FLAG_ACTIVE = 0b00000001
FLAG_VISIBLE = 0b00000010
FLAG_ENABLED = 0b00000100
FLAG_SELECTED = 0b00001000

# 初始状态
状态 = FLAG_ACTIVE | FLAG_VISIBLE  # 激活且可见

# 检查状态
是激活 = (状态 & FLAG_ACTIVE) != 0      # True
是启用 = (状态 & FLAG_ENABLED) != 0     # False

# 切换状态
状态 = 状态 ^ FLAG_VISIBLE  # 切换可见性

# 设置多个标志
状态 = 状态 | (FLAG_ENABLED | FLAG_SELECTED)

# 清除多个标志
状态 = 状态 & ~(FLAG_SELECTED | FLAG_ENABLED)
```

### 示例5：数据打包与解包

```python
# 打包：将多个小数据打包成一个大数据
# 格式：[类型:4位][版本:4位][长度:8位][标志:8位]
类型 = 0x5
版本 = 0x2
长度 = 0x40
标志 = 0xFF

数据包 = (类型 << 20) | (版本 << 16) | (长度 << 8) | 标志

# 解包
解包类型 = (数据包 >> 20) & 0xF   # 5
解包版本 = (数据包 >> 16) & 0xF   # 2
解包长度 = (数据包 >> 8) & 0xFF   # 64
解包标志 = 数据包 & 0xFF          # 255
```

### 示例6：位掩码应用

```python
# 创建掩码
# 低4位掩码
低4位掩码 = 0x0F  # 0b00001111

# 高4位掩码
高4位掩码 = 0xF0  # 0b11110000

# 应用掩码
数据 = 0xAB
低4位 = 数据 & 低4位掩码  # 0x0B
高4位 = 数据 & 高4位掩码  # 0xA0

# 交换高低4位
交换 = ((数据 & 低4位掩码) << 4) | ((数据 & 高4位掩码) >> 4)  # 0xBA
```

## 性能提示

1. **位运算比算术运算快**
   - `x * 2` → `x << 1`
   - `x / 2` → `x >> 1`
   - `x % 2` → `x & 1`

2. **使用位运算优化判断**
   - 判断奇偶：`x & 1`
   - 判断2的幂次：`(x & (x-1)) == 0`

3. **避免过度优化**
   - 现代编译器会自动优化
   - 可读性优先于微小的性能提升

## 调试技巧

### 使用 bitmap 查看位结构

```python
endian: big

# 查看数据的位结构
数据 = 0xAB
bitmap 查看数据 = 数据
```

### 分步骤验证

```python
# 复杂位运算分步骤
颜色 = 0xFF8040

# 步骤1：右移
步骤1 = 颜色 >> 16  # 0xFF

# 步骤2：掩码
步骤2 = 步骤1 & 0xFF  # 0xFF

# 最终结果
红色 = (颜色 >> 16) & 0xFF  # 0xFF
```

## 常见错误

### 1. 忘记使用括号

```python
# 错误
结果 = 数字 & 0xFF == 0  # 先比较，再与运算

# 正确
结果 = (数字 & 0xFF) == 0  # 先与运算，再比较
```

### 2. 负数的位运算

```python
# Python中负数使用补码表示
a = -1
结果 = a >> 1  # 结果仍然是-1（算术右移）

# 如果需要逻辑右移，先转换为无符号数
无符号 = a & 0xFFFFFFFF
结果 = 无符号 >> 1
```

### 3. 位移超出范围

```python
# 位移量不应超过数据类型的位数
a = 1
结果 = a << 100  # 可能产生意外结果
```

## 参考资料

- [使用指南](使用指南.md)
- [16进制注释格式说明](16进制注释格式说明.md)
- [bitmap关键字说明](bitmap关键字说明.md)
