# bitmap 关键字说明

版本：1.0

## 概述

`bitmap` 是 CalcPaper 的一个特殊关键字，用于详细查看数值的位结构，包括16进制表示、2进制表示和位索引表格。

## 基本用法

### 语法

```python
bitmap 变量名 = 表达式
```

### 示例

```python
endian: big
bitmap 查看 = 0xFF
```

输出：
```
bitmap 查看 = 0xFF    = 255 (0xFF, 0b11111111)
  十六进制: 0xFF
  二进制: 0b11111111
  位数: 8 bits (1 bytes)
  位索引 (大端字节序):
    |7 6 5 4 |3 2 1 0 |
    |1 1 1 1 |1 1 1 1 |
```

## 功能特性

### 1. 多格式显示

使用 `bitmap` 关键字时，结果会同时显示三种格式：

- 十进制：`255`
- 十六进制：`0xFF`
- 二进制：`0b11111111`

```python
bitmap a = 0xAB
# 输出：255 (0xFF, 0b11111111)
```

### 2. 位结构信息

显示详细的位结构信息：

- 十六进制表示
- 二进制表示
- 总位数和字节数
- 位索引表格（根据字节序）

### 3. 字节序支持

需要先设置字节序才能显示位索引表格：

```python
# 设置大端字节序
endian: big

# 或设置小端字节序
endian: little
```

## 字节序差异

### 大端字节序（Big Endian）

位索引从左到右递减（MSB到LSB）：

```python
endian: big
bitmap 查看 = 0xAB
```

输出：
```
  位索引 (大端字节序):
    |7 6 5 4 |3 2 1 0 |
    |1 0 1 0 |1 0 1 1 |
```

- 最左边是最高位（MSB，位7）
- 最右边是最低位（LSB，位0）
- 符合人类阅读习惯

### 小端字节序（Little Endian）

位索引从左到右递增（LSB到MSB）：

```python
endian: little
bitmap 查看 = 0xAB
```

输出：
```
  位索引 (小端字节序):
    |0 1 2 3 |4 5 6 7 |
    |1 0 1 0 |1 0 1 1 |
```

- 最左边是最低位（LSB，位0）
- 最右边是最高位（MSB，位7）
- 符合某些处理器的内存布局

## 使用场景

### 场景1：查看RGB颜色的位结构

```python
endian: big

# RGB颜色
颜色 = 0xFF8040

# 查看完整位结构
bitmap 查看颜色 = 颜色
```

输出：
```
bitmap 查看颜色 = 颜色    = 16744512 (0xFF8040, 0b111111111000000001000000)
  十六进制: 0xFF8040
  二进制: 0b111111111000000001000000
  位数: 24 bits (3 bytes)
  位索引 (大端字节序):
    |23 22 21 20 |19 18 17 16 |15 14 13 12 |11 10  9  8 |7 6 5 4 |3 2 1 0 |
    |1  1  1  1  |1  1  1  1  |1  0  0  0  |0  0  0  0  |0 1 0 0 |0 0 0 0 |
```

从位索引表格可以清楚看到：
- 位23-16（红色）：11111111 = 0xFF = 255
- 位15-8（绿色）：10000000 = 0x80 = 128
- 位7-0（蓝色）：01000000 = 0x40 = 64

### 场景2：调试位运算结果

```python
endian: big

# 位运算
a = 0xFF
b = 0x0F
与运算 = a & b

# 查看结果的位结构
bitmap 查看与运算 = 与运算
```

输出：
```
与运算 = a & b              = 15
bitmap 查看与运算 = 与运算   = 15 (0xF, 0b1111)
  十六进制: 0xF
  二进制: 0b00001111
  位数: 8 bits (1 bytes)
  位索引 (大端字节序):
    |7 6 5 4 |3 2 1 0 |
    |0 0 0 0 |1 1 1 1 |
```

### 场景3：理解位移操作

```python
endian: big

# 原始值
原始 = 0b1010

# 左移2位
左移 = 原始 << 2

# 查看位结构
bitmap 查看原始 = 原始
bitmap 查看左移 = 左移
```

输出：
```
原始 = 0b1010                = 10
bitmap 查看原始 = 原始        = 10 (0xA, 0b1010)
  十六进制: 0xA
  二进制: 0b00001010
  位数: 8 bits (1 bytes)
  位索引 (大端字节序):
    |7 6 5 4 |3 2 1 0 |
    |0 0 0 0 |1 0 1 0 |

左移 = 原始 << 2             = 40
bitmap 查看左移 = 左移        = 40 (0x28, 0b101000)
  十六进制: 0x28
  二进制: 0b00101000
  位数: 8 bits (1 bytes)
  位索引 (大端字节序):
    |7 6 5 4 |3 2 1 0 |
    |0 0 1 0 |1 0 0 0 |
```

可以清楚看到位向左移动了2位。

### 场景4：网络协议字段分析

```python
endian: big

# 协议头
协议头 = 0x12345678

# 查看完整结构
bitmap 查看协议头 = 协议头

# 提取字段
类型 = (协议头 >> 24) & 0xFF
版本 = (协议头 >> 16) & 0xFF
长度 = (协议头 >> 8) & 0xFF
标志 = 协议头 & 0xFF

# 查看各字段
bitmap 查看类型 = 类型
bitmap 查看版本 = 版本
bitmap 查看长度 = 长度
bitmap 查看标志 = 标志
```

## 与普通计算的区别

### 不使用 bitmap

只显示十进制结果：

```python
a = 0xFF
b = a & 0x0F
```

输出：
```
a = 0xFF        = 255
b = a & 0x0F    = 15  # 0xFF & 0xF
```

### 使用 bitmap

显示多种格式和位结构：

```python
endian: big
a = 0xFF
bitmap b = a & 0x0F
```

输出：
```
a = 0xFF                = 255
bitmap b = a & 0x0F     = 15 (0xF, 0b1111)
  十六进制: 0xF
  二进制: 0b00001111
  位数: 8 bits (1 bytes)
  位索引 (大端字节序):
    |7 6 5 4 |3 2 1 0 |
    |0 0 0 0 |1 1 1 1 |
```

## 限制和注意事项

### 1. 需要设置字节序

要显示位索引表格，必须先设置字节序：

```python
# 错误：未设置字节序
bitmap a = 0xFF  # 不会显示位索引表格

# 正确：先设置字节序
endian: big
bitmap a = 0xFF  # 会显示位索引表格
```

### 2. 只支持非负整数

`bitmap` 只能用于非负整数值：

```python
# 正确
bitmap a = 255

# 不适用
bitmap b = -10    # 负数
bitmap c = 3.14   # 浮点数
```

### 3. 位数自动对齐

位数会自动对齐到8的倍数（字节边界）：

```python
bitmap a = 0b1010  # 4位，会显示为8位：0b00001010
bitmap b = 0xFF    # 8位
bitmap c = 0xFFFF  # 16位
```

## 最佳实践

### 1. 合理使用 bitmap

只在需要详细查看位结构时使用 `bitmap`：

```python
# 普通计算：不需要 bitmap
a = 0xFF
b = 0x0F
和 = a + b

# 位运算调试：使用 bitmap
与运算 = a & b
bitmap 查看与运算 = 与运算
```

### 2. 选择合适的字节序

根据实际应用场景选择字节序：

- 网络协议：通常使用大端（big endian）
- x86/x64处理器：通常使用小端（little endian）
- ARM处理器：可能支持两种

### 3. 分步骤查看

对于复杂的位运算，分步骤使用 `bitmap` 查看：

```python
endian: big

# 步骤1
步骤1 = 0xFF8040 >> 16
bitmap 查看步骤1 = 步骤1

# 步骤2
步骤2 = 步骤1 & 0xFF
bitmap 查看步骤2 = 步骤2
```

### 4. 配合注释使用

添加注释说明每个 `bitmap` 的用途：

```python
endian: big

# 原始RGB颜色
颜色 = 0xFF8040
bitmap 查看颜色 = 颜色

# 提取红色分量
红色 = (颜色 >> 16) & 0xFF
bitmap 查看红色 = 红色  # 应该是0xFF
```

## 实用技巧

### 技巧1：对比不同字节序

```python
# 大端字节序
endian: big
bitmap 大端 = 0xABCD

# 小端字节序
endian: little
bitmap 小端 = 0xABCD
```

### 技巧2：验证位掩码

```python
endian: big

# 创建掩码
掩码 = 0xFF00
bitmap 查看掩码 = 掩码

# 应用掩码
数据 = 0xABCD
结果 = 数据 & 掩码
bitmap 查看结果 = 结果
```

### 技巧3：理解位移量

```python
endian: big

原始 = 0b1
bitmap 原始 = 原始

左移1 = 原始 << 1
bitmap 左移1 = 左移1

左移2 = 原始 << 2
bitmap 左移2 = 左移2

左移3 = 原始 << 3
bitmap 左移3 = 左移3
```

## 输出格式说明

### 位索引表格格式

```
  位索引 (大端字节序):
    |7 6 5 4 |3 2 1 0 |
    |1 0 1 0 |1 0 1 1 |
```

- 第一行：位索引号
- 第二行：对应的位值（0或1）
- 每4位一组，用空格分隔
- 用竖线 `|` 标记边界

### 多字节显示

对于多字节数据，会显示所有字节：

```
  位索引 (大端字节序):
    |31 30 29 28 |27 26 25 24 |23 22 21 20 |19 18 17 16 |15 14 13 12 |11 10  9  8 |7 6 5 4 |3 2 1 0 |
    |0  0  0  1  |0  0  1  0  |0  0  1  1  |0  1  0  0  |0  1  0  1  |0  1  1  0  |0 1 1 1 |1 0 0 0 |
```

## 相关文档

- [使用指南](使用指南.md)
- [位运算快速参考](位运算快速参考.md)
- [16进制注释格式说明](16进制注释格式说明.md)
